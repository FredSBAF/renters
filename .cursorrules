# ============================================================
# POURACCORD â€” Cursor AI Rules
# Plateforme B2B2C de gestion et validation de dossiers locataires
# Version : 2.0 | FÃ©vrier 2026
# ============================================================
# Ce fichier est lu par Cursor Ã  chaque conversation.
# Il donne Ã  l'IA le contexte permanent du projet ET pilote
# le workflow autonome Trello â†’ Git â†’ PR â†’ Trello.
# Ne pas supprimer ou modifier les sections [CRITIQUE].
# ============================================================


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. CONTEXTE PRODUIT
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Tu travailles sur POURACCORD, une plateforme B2B2C franÃ§aise permettant :
- Aux LOCATAIRES (gratuit) : constituer un dossier unique sÃ©curisÃ© et le partager avec des agences
- Aux AGENCES (800â‚¬ HT/mois, essai 30j) : accÃ©der Ã  des dossiers prÃ©-vÃ©rifiÃ©s par IA anti-fraude
- Aux ADMINS : modÃ©rer, gÃ©rer les utilisateurs et amÃ©liorer l'IA

Valeur clÃ© : validation anti-fraude multicouche par IA (8 niveaux) + conformitÃ© RGPD automatisÃ©e.

Environnements :
- Dev local  : localhost:3001 (backend) | localhost:3000 (frontend)
- Staging    : staging.pouraccord.com
- Production : api.pouraccord.com / pouraccord.com


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. STACK TECHNIQUE [CRITIQUE]
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

## Backend
- Runtime        : Node.js 20 LTS
- Framework      : Express 4.x
- Langage        : TypeScript 5.x strict
- ORM            : Sequelize 6.x (MySQL)
- Base de donnÃ©es: MySQL 8.0+ (charset utf8mb4, moteur InnoDB)
- Validation     : Joi (TOUS les inputs sans exception)
- Auth           : jsonwebtoken + speakeasy (2FA TOTP)
- Upload         : Multer + AWS SDK v3 (S3)
- Email          : Nodemailer + SendGrid
- Paiement       : Stripe Node.js SDK
- Logs           : Winston (src/utils/logger.ts)
- TÃ¢ches cron    : node-cron
- SÃ©curitÃ©       : helmet, express-rate-limit, cors

## Frontend
- Framework  : React 18.x
- Build      : Vite 4.x
- Langage    : TypeScript 5.x strict
- Ã‰tat global: Redux Toolkit + react-redux
- Routage    : React Router v6
- Formulaires: React Hook Form + Yup
- HTTP       : Axios (avec interceptors JWT)
- UI         : Tailwind CSS 3.x + Headless UI
- i18n       : react-i18next (FR prioritaire)

## Microservice IA (Python â€” dÃ©pÃ´t sÃ©parÃ©)
- Framework    : FastAPI
- OCR          : Tesseract 5.x
- ML           : scikit-learn / XGBoost
- Communication: HTTP REST (appelÃ© par backend Node.js)
- Endpoint     : POST /analyze

## Tests
- Backend  : Jest + Supertest (cible couverture : 80% minimum)
- Frontend : React Testing Library + Cypress (E2E)
- Helpers  : src/__tests__/helpers.ts (createActiveUser, loginTestUser, etc.)

## CI/CD
- GitHub Actions (.github/workflows/ci.yml)
- Pipeline : Lint â†’ Tests â†’ Coverage â†’ Build â†’ Deploy staging


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. STRUCTURE DU PROJET [CRITIQUE]
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

pouraccord/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ config/          # env.ts, database.ts, s3.ts, stripe.ts
â”‚   â”‚   â”œâ”€â”€ controllers/     # AuthController.ts, UserController.ts, FolderController.ts...
â”‚   â”‚   â”œâ”€â”€ middlewares/     # auth.middleware.ts, rateLimit.ts, audit.ts, upload.ts
â”‚   â”‚   â”œâ”€â”€ models/          # User.ts, Agency.ts, Folder.ts, Document.ts...
â”‚   â”‚   â”œâ”€â”€ routes/          # auth.routes.ts, users.routes.ts, folders.routes.ts...
â”‚   â”‚   â”œâ”€â”€ services/        # EmailService.ts, S3Service.ts, StripeService.ts, AIService.ts
â”‚   â”‚   â”œâ”€â”€ utils/           # logger.ts, response.ts, validators.ts, crypto.ts
â”‚   â”‚   â”œâ”€â”€ jobs/            # cleanupExpiredDocuments.ts, cleanupRefreshTokens.ts
â”‚   â”‚   â”œâ”€â”€ types/           # express.d.ts, index.ts
â”‚   â”‚   â””â”€â”€ app.ts
â”‚   â”œâ”€â”€ migrations/          # 001_create_users.ts, 002_create_agencies.ts...
â”‚   â”œâ”€â”€ seeders/             # document_types.ts, admin_user.ts
â”‚   â””â”€â”€ __tests__/
â”‚       â”œâ”€â”€ helpers.ts       # createActiveUser(), loginTestUser(), createTestAgency()...
â”‚       â”œâ”€â”€ setup.ts
â”‚       â””â”€â”€ teardown.ts
â”‚
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/      # Composants rÃ©utilisables (Button, Input, Modal...)
â”‚   â”‚   â”œâ”€â”€ pages/           # Register, Login, Dashboard, Documents, Settings...
â”‚   â”‚   â”œâ”€â”€ store/           # authSlice.ts, folderSlice.ts, store.ts
â”‚   â”‚   â”œâ”€â”€ services/        # api.ts (Axios instance), auth.service.ts...
â”‚   â”‚   â”œâ”€â”€ hooks/           # useAuth.ts, useFolder.ts, useDebounce.ts
â”‚   â”‚   â”œâ”€â”€ types/           # User.ts, Folder.ts, Document.ts, Agency.ts
â”‚   â”‚   â””â”€â”€ utils/           # formatters.ts, validators.ts, constants.ts
â”‚   â””â”€â”€ cypress/
â”‚
â”œâ”€â”€ .cursorrules             # CE FICHIER
â”œâ”€â”€ .cursor/mcp.json         # Configuration MCP (Trello, GitHub...)
â””â”€â”€ .github/workflows/


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. FORMAT DE RÃ‰PONSE API [CRITIQUE â€” JAMAIS DÃ‰ROGER]
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

TOUTES les rÃ©ponses API utilisent OBLIGATOIREMENT ce format :

```typescript
// SuccÃ¨s
{ success: true,  data: { ... }, message: "...", errors: [] }

// Erreur
{ success: false, data: null,    message: "...", errors: ["CODE_ERREUR"] }

// Liste paginÃ©e
{ success: true,  data: [...],   message: "...", errors: [],
  pagination: { page: 1, limit: 20, total: 150 } }
```

Helpers Ã  utiliser (src/utils/response.ts) :
```typescript
successResponse(res, data, message, statusCode = 200)
errorResponse(res, message, errors = [], statusCode = 400)
```

Codes HTTP :
- 200 : succÃ¨s GET/PATCH
- 201 : ressource crÃ©Ã©e (POST)
- 204 : succÃ¨s sans body (DELETE, logout)
- 400 : erreur validation input
- 401 : non authentifiÃ© (token absent/invalide/expirÃ©)
- 403 : authentifiÃ© mais rÃ´le insuffisant
- 404 : ressource inexistante
- 409 : conflit (email dÃ©jÃ  utilisÃ©, SIRET existant)
- 422 : entitÃ© non traitable
- 429 : trop de requÃªtes (rate limiting)
- 500 : erreur serveur inattendue


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. AUTHENTIFICATION & SÃ‰CURITÃ‰ [CRITIQUE]
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

## JWT
- Access token  : expire 24h (86400s), signÃ© HS256
- Refresh token : expire 7j (604800s), UUID v4, stockÃ© en BDD (table refresh_tokens)
- Payload JWT   : { sub: user.id, email, role, iat, exp }

## Middleware d'authentification (src/middlewares/auth.middleware.ts)
```typescript
authenticateToken              // VÃ©rifie JWT Bearer â€” obligatoire sur tout endpoint protÃ©gÃ©
requireRole('admin')           // ex: requireRole('admin', 'agency_owner')
```

## RÃ´les utilisateurs
- 'tenant'        : locataire (accÃ¨s Ã  son dossier uniquement)
- 'agency_owner'  : gÃ©rant (accÃ¨s dossiers agence + billing)
- 'agency_agent'  : agent (accÃ¨s dossiers agence)
- 'admin'         : administrateur plateforme (accÃ¨s total)

## Rate limiting (SYSTÃ‰MATIQUE sur endpoints sensibles)
- /auth/login           : 3 tentatives / 15 min / IP
- /auth/register        : 5 tentatives / 15 min / IP
- /auth/forgot-password : 3 tentatives / 30 min / IP
- API gÃ©nÃ©rale          : 100 req / 15 min / IP

## DONNÃ‰ES SENSIBLES â€” JAMAIS exposÃ©es dans les rÃ©ponses API
- password_hash, totp_secret, token de vÃ©rification email, token de reset password

## SÃ©curitÃ© fichiers uploadÃ©s
- Formats autorisÃ©s UNIQUEMENT : PDF, JPG, JPEG, PNG
- Taille max : 5 Mo par fichier
- Stockage S3 : /users/{user_id}/documents/{uuid}.{ext}
- Jamais d'exÃ©cution de fichiers uploadÃ©s


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6. MODÃˆLE DE DONNÃ‰ES PRINCIPAL
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

## Table users
- id, email (UNIQUE), password_hash, role (ENUM), status (ENUM)
- status        : 'pending_verification' | 'active' | 'suspended' | 'deleted'
- tenant_profile: 'employee_cdi' | 'employee_cdd' | 'student' | 'freelance' | 'retired' | 'other'
- totp_secret (chiffrÃ© AES-256), is_2fa_enabled, agency_id
- email_verified_at, last_login_at, created_at, updated_at, deleted_at (soft delete)

## Table agencies
- id, name, siret (UNIQUE, 14 chars), legal_name, address, phone
- status    : 'trial' | 'active' | 'suspended' | 'cancelled'
- trial_ends_at, subscription_id (Stripe), customer_id (Stripe), next_billing_date

## Table folders
- id, user_id (FK), status ('incomplete' | 'complete' | 'expired' | 'deleted')
- completion_percentage, ai_score_global
- ai_status : 'pending' | 'analyzing' | 'verified' | 'manual_review' | 'rejected'
- expires_at (6 mois â€” RGPD)

## Table documents
- id, folder_id (FK), document_type (FK document_types), file_path (S3)
- status    : 'pending_analysis' | 'valid' | 'rejected' | 'expired'
- ai_score, ai_warnings (JSON), extracted_data (JSON chiffrÃ©)
- original_filename, file_size, mime_type, version

## Table sharing_links
- id, folder_id (FK), token (UNIQUE UUID), created_by (agency_id ou null)
- expires_at, max_views (null = illimitÃ©), view_count, is_active

## Table refresh_tokens
- id, user_id (FK), token (VARCHAR 512), expires_at, revoked_at

## Table audit_logs (JAMAIS supprimer â€” conservation 3 ans)
- id, user_id, agency_id, ip_address, action, entity_type, entity_id, details (JSON)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 7. CONVENTIONS DE CODE [CRITIQUE]
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

## TypeScript
- Mode strict activÃ© (tsconfig strict: true)
- Pas de `any` non justifiÃ© â€” utiliser les types dÃ©finis dans src/types/
- Interfaces pour les objets de donnÃ©es, types pour les unions/primitives
- Exports nommÃ©s prÃ©fÃ©rÃ©s aux exports default (sauf pages React)

## Nommage
- Fichiers controllers : PascalCase + suffixe Controller (AuthController.ts)
- Fichiers routes      : kebab-case + .routes (auth.routes.ts)
- Fichiers models      : PascalCase (User.ts, RefreshToken.ts)
- Fonctions/variables  : camelCase
- Constantes           : UPPER_SNAKE_CASE
- Types/Interfaces     : PascalCase, prÃ©fixe I pour interfaces (IUser, IFolder)

## Gestion d'erreurs â€” pattern standard
```typescript
try {
  // logique mÃ©tier
  return successResponse(res, data, 'Message succÃ¨s');
} catch (error) {
  logger.error('Contexte erreur', { error, userId: req.user?.id });
  return errorResponse(res, 'Une erreur est survenue', ['INTERNAL_ERROR'], 500);
}
```

## Validation Joi â€” pattern standard
```typescript
const schema = Joi.object({ ... });
const { error, value } = schema.validate(req.body, { abortEarly: false });
if (error) {
  const errors = error.details.map(d => d.message);
  return errorResponse(res, 'DonnÃ©es invalides', errors, 400);
}
```

## Sequelize
- Toujours les modÃ¨les Sequelize â€” JAMAIS de SQL brut sauf absolue nÃ©cessitÃ©
- Transactions obligatoires pour les opÃ©rations multi-tables
- Exclure les champs sensibles : `attributes: { exclude: ['password_hash', 'totp_secret'] }`

## Logs Winston â€” niveaux
- logger.error()  : erreurs inattendues, exceptions
- logger.warn()   : comportements suspects, rate limiting dÃ©clenchÃ©
- logger.info()   : actions mÃ©tier importantes (login, upload, partage)
- logger.debug()  : dev uniquement (dÃ©sactivÃ© en production)

## Frontend â€” composants React
- Un composant = un fichier dans components/ ou pages/
- Toujours gÃ©rer les 3 Ã©tats : loading / error / data
- Formulaires via React Hook Form + validation Yup
- Jamais de styles inline â€” Tailwind uniquement
- Palette : primary #2563EB | success #10B981 | warning #F59E0B | error #EF4444


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 8. CONVENTIONS DE TESTS [CRITIQUE]
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

## RÃ¨gle d'or : TDD â€” Ã©crire les tests AVANT l'implÃ©mentation

## Structure des tests backend
```typescript
describe('NOM_ENDPOINT ou NOM_FONCTIONNALITÃ‰', () => {
  beforeAll(async () => { /* connexion DB, seed data */ });
  afterEach(async () => { /* nettoyer les donnÃ©es crÃ©Ã©es */ });
  afterAll(async () => { /* fermer connexions */ });

  test('should [comportement nominal]', async () => { ... });
  test('should return 400 if [validation Ã©choue]', async () => { ... });
  test('should return 401 if [non authentifiÃ©]', async () => { ... });
  test('should return 403 if [rÃ´le insuffisant]', async () => { ... });
  test('should return 404 if [ressource inexistante]', async () => { ... });
  test('should return 409 if [conflit]', async () => { ... });
  test('should return 429 if [rate limit atteint]', async () => { ... });
});
```

## Helpers disponibles (src/__tests__/helpers.ts)
```typescript
createActiveUser(email?, password?)   // CrÃ©e un user actif
createPendingUser(email?, password?)  // CrÃ©e un user non vÃ©rifiÃ©
loginTestUser(role?)                  // Retourne { accessToken, refreshToken, user }
createTestAgency()                    // CrÃ©e une agence en trial
createTestFolder(userId)             // CrÃ©e un dossier pour un locataire
createPasswordResetToken(userId)     // CrÃ©e un token de reset valide
```

## RÃ¨gle de sÃ©curitÃ© des tests
```typescript
// JAMAIS vÃ©rifier qu'un champ sensible EST prÃ©sent
// TOUJOURS vÃ©rifier qu'il est ABSENT :
expect(res.body.data.password_hash).toBeUndefined(); // âœ…
expect(res.body.data.totp_secret).toBeUndefined();   // âœ…
```

## Couverture minimale
- 100% sur les modules auth et RGPD (critique)
- 80% sur les modules mÃ©tier
- `npm run test:coverage`


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 9. RGPD â€” RÃˆGLES ABSOLUES [CRITIQUE]
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. CONSENTEMENT : tout accÃ¨s donnÃ©es locataire â†’ consentement explicite tracÃ©
   â†’ Table user_consents : consent_type, consented_at, ip_address

2. DURÃ‰E DE VIE : dossiers supprimÃ©s automatiquement aprÃ¨s 6 mois (CRON quotidien)
   â†’ Alerte email 30j avant | Job : src/jobs/cleanupExpiredDocuments.ts

3. SUPPRESSION : endpoint DELETE /users/me
   â†’ Soft delete user (deleted_at) + suppression physique S3 (async)
   â†’ Hard delete extracted_data + anonymisation audit_logs (user_id â†’ '<deleted>')
   â†’ DÃ©lai de grÃ¢ce : 30 jours avant hard delete dÃ©finitif

4. AUDIT : tout accÃ¨s Ã  un dossier est loggÃ© (table audit_logs)
   â†’ Conservation minimum 3 ans | JAMAIS supprimer des audit_logs

5. EXPORT : endpoint GET /users/me/data-export
   â†’ ZIP : JSON toutes donnÃ©es + fichiers S3 | Presigned URL (expire 24h)

6. WATERMARKING : tout PDF tÃ©lÃ©chargÃ© par une agence porte un watermark
   â†’ Visible : nom agence + date
   â†’ Invisible (stÃ©ganographie LSB) : identifiant unique agence/agent


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 10. MODULE IA ANTI-FRAUDE â€” ARCHITECTURE
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Communication : backend Node.js â†’ POST http://ai-service/analyze

8 niveaux d'analyse :
1. ExhaustivitÃ©  : documents obligatoires prÃ©sents selon profil ?
2. ConformitÃ©    : format valide, lisible, OCR possible ?
3. ValiditÃ©      : NIR valide, MRZ correcte, SIRET existant ?
4. AuthenticitÃ©  : employeur vÃ©rifiÃ© INSEE, adresse vÃ©rifiÃ©e API gouv ?
5. CohÃ©rence intra : cohÃ©rence interne d'un mÃªme document
6. CohÃ©rence inter : cohÃ©rence entre documents (nom, dates, revenus)
7. IntÃ©gritÃ©     : mÃ©tadonnÃ©es PDF, dÃ©tection altÃ©rations visuelles (ELA)
8. AdÃ©quation    : revenus â‰¥ 3x loyer ?

Scores : 0-100 par document + score global dossier
Status : 'verified' (â‰¥85) | 'manual_review' (60-84) | 'rejected' (<60)

APIs externes du microservice IA :
- INSEE SIRET : https://api.insee.fr/entreprises/sirene/V3/siret/{SIRET}
- API Adresse : https://api-adresse.data.gouv.fr/search/
- MRZ parsing : librairie mrz (Python)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 11. VARIABLES D'ENVIRONNEMENT â€” RÃ‰FÃ‰RENCE
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Toutes les variables sont dans .env (local) / .env.test (tests).
ValidÃ©es au dÃ©marrage via Joi dans src/config/env.ts.
JAMAIS de valeur en dur dans le code.

## Backend
- DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD
- JWT_SECRET (min 32 chars), JWT_EXPIRES_IN
- JWT_REFRESH_SECRET (min 32 chars), JWT_REFRESH_EXPIRES_IN
- AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_REGION, AWS_S3_BUCKET
- SENDGRID_API_KEY, EMAIL_FROM, EMAIL_FROM_NAME
- TOTP_SECRET_ENCRYPTION_KEY (32 chars â€” AES-256)
- STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET
- AI_SERVICE_URL
- FRONTEND_URL (pour CORS et liens emails)

## Trello (via MCP ou script)
- TRELLO_API_KEY, TRELLO_API_TOKEN
- TRELLO_TODO_LIST_ID          # "Ã€ faire"
- TRELLO_IN_PROGRESS_LIST_ID   # "En cours"
- TRELLO_REVIEW_LIST_ID        # "En revue"
- TRELLO_DONE_LIST_ID          # "TerminÃ©"

## GitHub CLI
- GH_TOKEN (ou `gh auth login`)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 12. WORKFLOW AUTONOME TRELLO â†’ GIT â†’ PR â†’ TRELLO [CRITIQUE]
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

## Commandes en langage naturel

| Tu dis...                      | Cursor fait...                              |
|--------------------------------|---------------------------------------------|
| "next" / "suivant" / "go"      | Cycle complet (Ã©tapes 1 Ã  9 ci-dessous)     |
| "travaille sur [nom/ID carte]" | Force cette carte et dÃ©marre le cycle       |
| "statut" / "en cours ?"        | Affiche les cartes In Progress + Review     |
| "pr" / "c'est prÃªt"            | Ouvre la PR + dÃ©place carte en "En revue"  |
| "terminÃ©" / "merge fait"       | DÃ©place la carte en "TerminÃ©"               |
| "bloquÃ© : [raison]"            | Commente + dÃ©place en "BloquÃ©"              |

---

## Cycle complet â€” 9 Ã©tapes

### Ã‰TAPE 1 â€” RÃ©cupÃ©rer la prochaine carte "Ã€ faire"

Via MCP Trello (configurÃ© dans .cursor/mcp.json) ou curl :
```bash
curl -s "https://api.trello.com/1/lists/${TRELLO_TODO_LIST_ID}/cards\
?key=${TRELLO_API_KEY}&token=${TRELLO_API_TOKEN}\
&fields=id,name,desc,labels,shortLink,shortUrl" | jq '.[0]'
```

PrioritÃ© de sÃ©lection : ğŸ”´ critique > ğŸŸ  haute-prioritÃ© > ğŸŸ£ bug > ğŸŸ¡ normale > ordre naturel.
Si aucune carte â†’ afficher "âœ… Backlog vide" et s'arrÃªter.

### Ã‰TAPE 2 â€” DÃ©placer la carte en "En cours" + commenter

```bash
# DÃ©placer
curl -s -X PUT "https://api.trello.com/1/cards/${CARD_ID}\
?key=${TRELLO_API_KEY}&token=${TRELLO_API_TOKEN}" \
  --data-urlencode "idList=${TRELLO_IN_PROGRESS_LIST_ID}"

# Commenter
curl -s -X POST "https://api.trello.com/1/cards/${CARD_ID}/actions/comments\
?key=${TRELLO_API_KEY}&token=${TRELLO_API_TOKEN}" \
  --data-urlencode "text=ğŸš€ DÃ©veloppement dÃ©marrÃ© sur \`${BRANCH_NAME}\` â€” $(date '+%d/%m/%Y %H:%M')"
```

### Ã‰TAPE 3 â€” CrÃ©er la branche Git

Nommage : `{type}/{shortId}-{slug}`
- `feature/` â†’ nouvelle fonctionnalitÃ© (dÃ©faut)
- `fix/`     â†’ correction de bug (label ğŸŸ£ bug sur la carte)
- `chore/`   â†’ tÃ¢che technique, migration, config (label âš« technique)

```bash
git checkout main && git pull origin main
git checkout -b "${BRANCH_NAME}"
git push -u origin "${BRANCH_NAME}"
```

### Ã‰TAPE 4 â€” Analyser et planifier

1. Lire la description complÃ¨te de la carte
2. Identifier les fichiers Ã  crÃ©er/modifier (backend / frontend / ai-service)
3. RepÃ©rer les tables BDD impactÃ©es et les migrations nÃ©cessaires
4. Lister les tests Ã  Ã©crire (TDD â€” tous les cas : nominal, 400, 401, 403, 404, 409, 429)
5. Afficher le plan complet avant de commencer Ã  coder

### Ã‰TAPE 5 â€” DÃ©velopper (TDD obligatoire)

Ordre strict :
1. Ã‰crire les tests (describe + tous les cas attendus)
2. Lancer les tests â†’ ils doivent Ãªtre ROUGES
3. ImplÃ©menter le code minimal pour les faire passer
4. Refactoriser si besoin
5. RÃ©pÃ©ter jusqu'Ã  ce que tous les cas soient couverts

Commits atomiques pendant le dÃ©veloppement :
```bash
git add -p
git commit -m "type(scope): description claire en franÃ§ais"
# Types : feat | fix | refactor | test | docs | chore | style
```

### Ã‰TAPE 6 â€” VÃ©rifications avant PR

```bash
npm run lint          # zÃ©ro erreur TypeScript / ESLint
npm test              # 100% passing
npm run test:coverage # â‰¥ 80% global, 100% auth + RGPD
npm run build         # zÃ©ro erreur de build TypeScript (frontend)
```
â›” Ne jamais ouvrir de PR si l'une de ces commandes Ã©choue.

### Ã‰TAPE 7 â€” Checklist "DÃ©finition de Done"

- [ ] Tous les critÃ¨res d'acceptance de la carte sont satisfaits
- [ ] `npm test` â†’ 100% passing
- [ ] Coverage â‰¥ 80% (100% sur auth/RGPD)
- [ ] `npm run lint` â†’ zÃ©ro erreur
- [ ] `npm run build` â†’ zÃ©ro erreur TypeScript
- [ ] Aucune donnÃ©e sensible exposÃ©e dans les rÃ©ponses
- [ ] Pas de `console.log`, `TODO` ou `any` non justifiÃ© oubliÃ©
- [ ] Nouvelles variables d'environnement documentÃ©es dans .env.example

### Ã‰TAPE 8 â€” CrÃ©er la Pull Request

```bash
gh pr create \
  --title "[${CARD_SHORT_ID}] ${CARD_NAME}" \
  --body "$(cat .github/PULL_REQUEST_TEMPLATE.md | envsubst)" \
  --base main \
  --head "${BRANCH_NAME}"
```

Template PR (Ã  crÃ©er dans `.github/PULL_REQUEST_TEMPLATE.md`) :
```markdown
## ğŸ“‹ Fiche Trello
[${CARD_NAME}](${CARD_SHORT_URL})

## ğŸ¯ Objectif
<!-- 1-2 phrases rÃ©sumant ce que fait cette PR -->

## ğŸ”§ Changements
- `backend/`    : ...
- `frontend/`   : ...
- `ai-service/` : ... (si applicable)

## âœ… CritÃ¨res d'acceptance
- [ ] CritÃ¨re 1 (issu de la carte Trello)
- [ ] CritÃ¨re 2

## ğŸ§ª Tests
- [ ] `npm test` â†’ âœ… 100% passing
- [ ] `npm run test:coverage` â†’ â‰¥ 80%
- [ ] `npm run lint` â†’ âœ… zÃ©ro erreur
- [ ] `npm run build` â†’ âœ… zÃ©ro erreur TypeScript
- [ ] Pas de rÃ©gression

## ğŸ“¸ Screenshots
<!-- Si changement d'interface -->

## âš ï¸ Points d'attention pour le reviewer
<!-- ComplexitÃ©, choix d'archi, risques -->

## ğŸ”— DÃ©pendances
<!-- Autres PRs Ã  merger avant/aprÃ¨s -->
```

### Ã‰TAPE 9 â€” Mettre Ã  jour Trello

```bash
# DÃ©placer en "En revue"
curl -s -X PUT "https://api.trello.com/1/cards/${CARD_ID}\
?key=${TRELLO_API_KEY}&token=${TRELLO_API_TOKEN}" \
  --data-urlencode "idList=${TRELLO_REVIEW_LIST_ID}"

# Commenter avec le lien de la PR
PR_URL=$(gh pr view --json url -q .url)
curl -s -X POST "https://api.trello.com/1/cards/${CARD_ID}/actions/comments\
?key=${TRELLO_API_KEY}&token=${TRELLO_API_TOKEN}" \
  --data-urlencode "text=ğŸ‘ï¸ PR ouverte : ${PR_URL} â€” $(date '+%d/%m/%Y %H:%M')

- [x] DÃ©veloppement terminÃ©
- [x] Tests passent (coverage â‰¥ 80%)
- [x] PR crÃ©Ã©e et en attente de review
- [ ] Review approuvÃ©e
- [ ] Merge sur main"
```

Demander ensuite : "Voulez-vous passer Ã  la prochaine carte ? (oui/non)"

---

## Architecture du board Trello

| Colonne          | Signification                         |
|------------------|---------------------------------------|
| ğŸ“‹ Backlog       | IdÃ©es et fonctionnalitÃ©s futures      |
| ğŸ¯ Ã€ faire       | PrÃªt Ã  dÃ©velopper (prioritÃ© dÃ©finie)  |
| ğŸ”§ En cours      | DÃ©veloppement actif                   |
| ğŸ‘ï¸ En revue     | PR ouverte, attente de review         |
| âœ… TerminÃ©       | MergÃ© sur main                        |
| ğŸš« BloquÃ©        | En attente d'une dÃ©pendance externe   |

## Labels Trello et impact sur le nommage des branches
- ğŸ”´ `critique`       â†’ prioritÃ© absolue | branche `fix/`
- ğŸŸ  `haute-prioritÃ©` â†’ prioritÃ© haute   | branche `feature/`
- ğŸŸ¡ `normale`        â†’ prioritÃ© normale | branche `feature/`
- ğŸŸ£ `bug`            â†’ correction       | branche `fix/`
- âš« `technique`      â†’ dette technique  | branche `chore/`
- ğŸ”µ `amÃ©lioration`   â†’ nice-to-have     | branche `feature/`


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 13. RÃˆGLES DE COMPORTEMENT CURSOR
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. Toujours lire la description COMPLÃˆTE de la carte avant de coder
2. Respecter les critÃ¨res d'acceptance de la carte Ã  la lettre
3. Demander validation avant tout changement d'architecture non prÃ©vu dans la carte
4. Un commit = une modification cohÃ©rente et isolÃ©e (jamais de "wip" ou "misc")
5. JAMAIS pusher directement sur `main` â€” toujours via PR
6. Si la tÃ¢che dÃ©passe 1 jour estimÃ© â†’ la dÃ©couper en sous-cartes Trello
7. En cas de doute sur l'implÃ©mentation â†’ commenter la carte + passer en "BloquÃ©"
8. Tickets indÃ©pendants â†’ peuvent tourner en parallÃ¨le (vÃ©rifier les dÃ©pendances avant)
9. Merger dans l'ordre des dÃ©pendances dÃ©clarÃ©es sur les cartes
10. Ne jamais exposer de stack trace en production

## Agent Mode vs Ask Mode
- Agent Mode â†’ implÃ©menter une feature, crÃ©er des fichiers, Ã©crire des tests
- Ask Mode   â†’ comprendre du code existant, planifier, questions d'archi


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 14. SPRINTS EN COURS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Sprint 0 â€” Fondations (semaine 1-2)
  SETUP-01 : Monorepo backend + frontend
  SETUP-02 : Variables d'environnement + validation Joi
  SETUP-03 : Migrations BDD (users, agencies, refresh_tokens, email_verification_tokens)
  SETUP-04 : GET /health + Logger Winston
  SETUP-05 : CI/CD GitHub Actions

Sprint 1 â€” Authentification (semaine 3-4)
  AUTH-01 : POST /auth/register
  AUTH-02 : POST /auth/verify-email
  AUTH-03 : POST /auth/login (JWT + refresh token)
  AUTH-04 : POST /auth/refresh + POST /auth/logout
  AUTH-05 : POST /auth/forgot-password + /auth/reset-password
  AUTH-06 : Middleware JWT + GET /users/me + PATCH /users/me
  AUTH-07 : 2FA locataire (enable + verify + disable)
  AUTH-08 : Frontend React (Register, Login, VerifyEmail + Redux auth slice)

Sprints Ã  venir : Module Locataire â†’ Module Agence â†’ Module IA â†’ Admin + RGPD
